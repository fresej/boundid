---
output: github_document
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# boundid

The **boundid** package accompanies the paper "Going Through the Roof: Difference-in-Differences Designs in Contexts of Natural Boundaries" by Ludwig Schulze and Joris Frese. In this paper, we discuss parallel trends violations in difference-in-differences estimations where treated units are unable to follow the counterfactual control trend post-treatment due to natural boundaries to the scale of the outcome variable.

The goal of the **boundid** package is to quantify the bias resulting from this parallel trends violation and account for it with various trimming- and weighting-based methods. The package is built around two complementary functions: **boundid_test** and **boundid_adjust**.


## Installation

You can install the development version of boundid like so:

``` r
devtools::install_github("fresej/boundid")
```

## boundid_test

The **boundid_test** function is used to evaluate (the extent of) boundary bias in a difference-in-differences setup. It contains the following parameters:

**Data**: An R dataframe.

**X_var**: The outcome variable.

**threshold**: The natural boundary of the outcome.

**floor**: A logical statement. Should be set to TRUE if the boundary is a floor, or to FALSE if the boundary is a ceiling. Default is TRUE.

**treatment**: The treatment variable.

**time**: The time variable.

**ID**: The unit ID.

**first_period**: A numeric value indicating the first time period in which the treatment is administered.

**S**: A numeric value indicating the counterfactual fall. If NULL, the function automatically computes the counterfactual fall of the  control group.

**more_info**: A logical statement. If TRUE, then additional information is included in the output, such as the distance of the furthest unit above or below the boundary (or the distance of the 1st percentile):

**stag**: A logical statement. Should be TRUE if the design is staggered or FALSE for a basic 2x2 DiD.

The **output** of this function is a console output containing information about the extent of boundary bias, including, but not limited to, the pre-treatment means of the control and the treatment group, the trend of the control group (which is the counterfactual trend for the treatment group), the number of observations in the treatment group going below the natural boundary if they follow the counterfactual trend, the treatment group post-treatment means with and without natural boundaries after following the counterfactual trend, and a t-test of the difference between those two means.



## boundid_adjust

The **boundid_adjust** function is used to prepare weighting or trimming parameters before the DiD estimation step to counteract boundary bias. In the weighting approach, these weights take on values between 0 and 1. In the trimming approach, these weights take on either the value 0 or the value 1. The function contains the following parameters:

**Data**: An R dataframe.

**X_var**: The outcome variable.

**threshold**: The natural boundary of the outcome.

**floor**: A logical statement. Should be set to TRUE if the boundary is a floor, or to FALSE if the boundary is a ceiling. Default is TRUE.

**treatment**: The treatment variable.

**time**: The time variable.

**ID**: The unit ID.

**group2_mean**: A numeric value indicating the pre-treatment mean of the treatment group.

**ATU**: A logical statement. TRUE if the ATU is the target estimand.

**ATT**: A logical statement. TRUE if the ATT is the target estimand.

**S**: A numeric value indicating the counterfactual fall. If NULL, the function automatically computes the counterfactual fall of the control group.

**cut**: A logical statement. If TRUE, then the cutting/trimming approach will be used. If FALSE, then the weighting approach will be used.

**panel**: A logical statement. If TRUE, then the function generates weights for the whole panel. If FALSE, then the function generates weights for two time periods.

The **output** of this function is a vector containing the newly generated weights to be included in the estimation step to counter-act boundary bias.


## Example

This is a basic example using simulated data to demonstrate how to use the boundid_test and boundid_adjust functions in the boundid package to estimate boundary bias and adjust for it with the weighting and the trimming approach in a classic 2x2 DiD setup:

```{r example}
suppressWarnings({
  library(boundid)
  library(tidyverse)
  library(fixest)
})

# Data simulation
set.seed(123)
n <- 500

time_1 <- data.frame(
  ID = 1:n,
  X = rnorm(n, mean = 10, sd = 3)
)

time_2 <- data.frame(
  ID = 1:n,
  X = rnorm(n, mean = 7, sd = 3)
)

simulated_data_1 <- rbind(
  cbind(time_1, time = 0),  
  cbind(time_2, time = 1)  
)

simulated_data_1$treated <- 0

time_3 <- data.frame(
  ID = (n+1):(2*n),
  X = rnorm(n, mean = 7, sd = 3)
)

time_4 <- data.frame(
  ID = (n+1):(2*n),
  X = rnorm(n, mean = 7, sd = 3)
)

simulated_data_2 <- rbind(
  cbind(time_3, time = 0), 
  cbind(time_4, time = 1)  
)

simulated_data_2$treated <- 1

simulated_data <- rbind(simulated_data_1, simulated_data_2)

simulated_data <- simulated_data %>% 
  arrange(ID, time)

means <- simulated_data %>%
  group_by(time, treated) %>%
  summarise(mean_X = mean(X, na.rm = TRUE))

ggplot(means, aes(x = factor(time), y = mean_X, color = factor(treated))) +
  geom_point(size = 3) +
  labs(title = "Mean of X for Time Periods and Treatment Groups",
       x = "Time Period", y = "Mean of X", color = "Treatment Group") +
  scale_color_manual(values = c("blue", "red")) +
  theme_minimal()

# run test
boundid_test(simulated_data, "X", 0, floor = T, simulated_data$treated, simulated_data$time, 
             more_info = T, ID = "ID")

# create weights
test_weights <- boundid_adjust(simulated_data, "X", 0, floor = T,treatment = simulated_data$treated, 
                               time = simulated_data$time, ID = simulated_data$ID, ATT = T, 
                               cut = F, panel = F,orig_ID = simulated_data$ID)

# cut observations
test_cuts <- boundid_adjust(simulated_data, "X", 0, floor = T,treatment = simulated_data$treated, 
                            time = simulated_data$time, ID = simulated_data$ID, ATT = T, cut = T, 
                            panel = F,orig_ID = simulated_data$ID)

# see weights
table(test_weights)

# see cuts
table(test_cuts)


# run DiD regressions
## unadjusted
biased <- feols(X ~ treated*time|factor(time) + factor(ID)  ,data=simulated_data, cluster = "ID")

##weighted
weighted <- feols(X ~ treated*time|factor(time) + factor(ID)  ,data=simulated_data, cluster = "ID", weights = test_weights)

## trimmed
trimmed <- feols(X ~ treated*time|factor(time) + factor(ID)  ,data=simulated_data, cluster = "ID", weights = test_cuts)


# plot DiD coefficients
coef_biased <- coef(biased)["treated:time"]
coef_weighted <- coef(weighted)["treated:time"]
coef_trimmed <- coef(trimmed)["treated:time"]
se_biased <- summary(biased)$coeftable["treated:time", "Std. Error"]
se_weighted <- summary(weighted)$coeftable["treated:time", "Std. Error"]
se_trimmed <- summary(trimmed)$coeftable["treated:time", "Std. Error"]

lower_biased <- coef_biased - 1.96 * se_biased
upper_biased <- coef_biased + 1.96 * se_biased
lower_weighted <- coef_weighted - 1.96 * se_weighted
upper_weighted <- coef_weighted + 1.96 * se_weighted
lower_trimmed <- coef_trimmed - 1.96 * se_trimmed
upper_trimmed <- coef_trimmed + 1.96 * se_trimmed

results <- data.frame(
  model = c("Biased (Unadjusted)", "Weighted (boundid)", "Trimmed (boundid)"),
  estimate = c(coef_biased, coef_weighted, coef_trimmed),
  lower = c(lower_biased, lower_weighted, lower_trimmed),
  upper = c(upper_biased, upper_weighted, upper_trimmed)
)

ggplot(results, aes(x = model, y = estimate, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, size = 1, color = "red", linetype = "dashed") +
  geom_pointrange(size = 2, linewidth = 2) +
  labs(x = "Model", y = "DiD Coefficient", 
       title = "DiD Coefficients with 95% Confidence Intervals") +
  theme_minimal(base_size = 25)



```



